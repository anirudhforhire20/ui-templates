<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/global.style.css">
    <title>Join Jam Session now</title>
</head>
<body class="secondary" style="
display: flex;
    align-items: center;
    justify-content: center;
">
    <header class="primary header">
        <h1 class="tm-font">Lorem Ipsum</h1>
        <a class="btn secondary" style="width: 85px; height: 36px; color: white;">Login</a>
    </header>
    <link rel="stylesheet" href="../static/form.style.css">
    <form id="signup-form-1" class="flash-card form" method="POST" action="/auth/signup">
        <div class="form-pages">
            <div id="page-1" class="form-page">
                <legend>Join us now</legend>
    
                <input id="cors_token" name="cors_token" type="hidden" value="{{cors_token}}">
                <fieldset id="name">
                    <input name="name" type="text" placeholder=" ">
                    <label>Name</label>
                    <span>Please enter full name, use initials if you want</span>
                </fieldset>
    
                <fieldset id="date">
                    <input name="dob" type="date" placeholder=" ">
                    <label>Birthday</label>
                    <span>You must be 18 or older to join</span>
                </fieldset>
    
                <div class="btn-grp">
                    <button class="btn primary form-submit" type="button">Next</button>
                </div>
    
                <!-- <button class="btn primary form-submit" type="submit">Naxt</button> -->
            </div>
    
            <div id="page-2" class="form-page">
                <legend>Email for quick verification</legend>
    
                <fieldset id="email" style="margin-bottom: 100px;">
                    <input name="email" type="text" placeholder=" ">
                    <label>Email</label>
                    <span>Please enter email for authentication</span>
                </fieldset>
    
    
                <div class="btn-grp">
                    <button id="btn-1" class="btn primary form-submit" type="button">Back</button>
                    <button id="btn-2" class="btn primary form-submit" type="button">Next</button>
                </div>
            </div>

            <div id="page-3" class="form-page">
                <legend>Let's get started</legend>
    
    
                <fieldset id="uname">
                    <input name="uname" type="text" placeholder=" ">
                    <label>Username</label>
                    <span>Enter a username. Make it stand out!!</span>
                </fieldset>
    
                <fieldset id="password">
                    <input name="password" type="password" placeholder=" ">
                    <label>Password</label>
                    <span>Enter a strong password.</span>
                </fieldset>
    
    
                <div class="btn-grp">
                    <button id="btn-1" class="btn primary form-submit" type="button">Back</button>
                    <button id="btn-2" class="btn primary form-submit" type="button">Next</button>
                </div>
            </div>

            <div id="page-4" class="form-page">
                <legend>Choose a profile picture</legend>

                <img id="pfp-display" class="pfp">
    
                <fieldset>
                    <input id="pfp" type="file" accept="image/*">
                    <input name="pfp-url" id="pfp-url" type="hidden">
                </fieldset>

                <span id="client-check-err" style="color: red;"></span>

                <div class="btn-grp">
                    <button id="btn-1" class="btn primary form-submit" type="button">Back</button>
                    <button id="btn-2" class="btn primary form-submit" type="submit">Signup</button>
                </div>
            </div>
        </div>
    </form>
    <script>
        document.querySelector('.form-pages').querySelector('#page-1').querySelector('button').onclick = () => {
            document.querySelector('.form-pages').style.left = '-497px';
        }

        document.querySelector('.form-pages').querySelector('#page-2').querySelector('#btn-1').onclick = () => {
            document.querySelector('.form-pages').style.left = '-0px';
        }

        document.querySelector('.form-pages').querySelector('#page-2').querySelector('#btn-2').onclick = () => {
            document.querySelector('.form-pages').style.left = '-994px';
        }

        document.querySelector('.form-pages').querySelector('#page-3').querySelector('#btn-1').onclick = () => {
            document.querySelector('.form-pages').style.left = '-497px';
        }

        document.querySelector('.form-pages').querySelector('#page-3').querySelector('#btn-2').onclick = () => {
            document.querySelector('.form-pages').style.left = '-1491px';
        }

        document.querySelector('.form-pages').querySelector('#page-4').querySelector('#btn-1').onclick = () => {
            document.querySelector('.form-pages').style.left = '-994px';
        }



        //image cropping
        let imgfile = document.getElementById('pfp');
        let img = document.getElementById('pfp-display');
        let imgemded = document.getElementById('pfp-url');
        imgfile.onchange = () => {
            if(imgfile.files && imgfile.files[0])
            {
                console.log(imgfile.files[0].size);
                if(imgfile.files[0].size > 2000000)
                {
                    window.alert('Image size too big, it should be 2MB max');
                    imgfile.value = '';
                }
                else
                {
                    let reader = new FileReader();
                    reader.onload = (e) => {
                        img.src = e.target.result;
                        imgemded.value = e.target.result;
                    }
                    reader.readAsDataURL(imgfile.files[0]);
                }
            }
        }



        document.getElementById('signup-form-1').onsubmit = async function(event) {
            event.preventDefault();

            //name check
            let name = document.querySelector('#name').querySelector('input').value;
            let nameMsg = document.querySelector('#name').querySelector('span');
            let nameCheck = Name(name);
            console.log(nameCheck);
            if(nameCheck.pass == false)
            {
                console.log(nameCheck.err)
                nameMsg.style.color = '#ff0000';
                nameMsg.innerText = nameCheck.err;
            }

            //email check
            let email = document.querySelector('#email').querySelector('input').value;
            let emailMsg = document.querySelector('#email').querySelector('span');
            let emailCheck = Email(email);
            if(emailCheck.pass == false)
            {
                console.log(emailCheck.err);
                emailMsg.style.color = '#ff0000';
                emailMsg.innerText = emailCheck.err;
            }


            //username check
            let uname = document.querySelector('#uname').querySelector('input').value;
            let unameMsg = document.querySelector('#uname').querySelector('span');
            let unameCheck = await Username(uname);
            console.log(unameCheck)
            if(unameCheck.pass == false)
            {
                console.log(unameCheck.err);
                unameMsg.style.color = '#ff0000';
                unameMsg.innerText = unameCheck.err;
            }

            //password check
            let password = document.querySelector('#password').querySelector('input').value;
            let passwordMsg = document.querySelector('#password').querySelector('span');
            let passwordCheck = Password(password);
            if(passwordCheck.pass == false)
            {
                console.log(passwordCheck.err)
                passwordMsg.style.color = '#ff0000';
                passwordMsg.innerText = passwordCheck.err;
            }

            let xhr = new XMLHttpRequest();
            let res = {};
            xhr.onload = () => {
                res = JSON.parse(xhr.responseText);
                if(res.pass == false)
                {
                    document.getElementById('client-check-err').innerText = res.err;
                }
                else
                {
                    let pass = (nameCheck.pass && emailCheck.pass && unameCheck.pass && passwordCheck.pass && res.pass);
                    if(pass == true)
                    {

                        console.log('submitting');
                        document.getElementById('pfp').value = '';
                        this.submit();
                    }
                }
            }
            xhr.open('POST', '/auth/check');
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                "cors_token" : document.getElementById('cors_token').value,
                "email" : document.querySelector('#email').querySelector('input').value,
                "uname" : document.querySelector('#uname').querySelector('input').value
            }));

            // let pass = await (nameCheck.pass && emailCheck.pass && unameCheck.pass && passwordCheck.pass && await res.pass);
            // console.log(await pass);
            // if(await pass == true)
            // {
            //     console.log('submitting');
            //     this.submit();
            // }
        }
    </script>
    <script src="../static/form.validators.js"></script>
</body>
</html>